<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>系统设置 - DocuHub</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet" />
    <link th:href="@{/css/bootstrap-icons.css}" rel="stylesheet" />
    <link th:href="@{/css/custom.css}" rel="stylesheet" />
</head>
<body>
    <div th:replace="fragments/navigation :: navbar"></div>
    <div th:replace="fragments/navigation :: alerts"></div>
    <div class="container-fluid mt-4">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/dashboard">
                                <i class="bi bi-speedometer2"></i> 控制台
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/users">
                                <i class="bi bi-people"></i> 用户管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/documents">
                                <i class="bi bi-file-earmark-text"></i> 文档管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/logs">
                                <i class="bi bi-clock-history"></i> 操作日志
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin/system">
                                <i class="bi bi-gear"></i> 系统设置
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">系统设置</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">系统概览</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <p><strong>操作系统:</strong></p>
                                        <p th:text="${osName + ' ' + osVersion}">-</p>
                                        
                                        <p><strong>Java版本:</strong></p>
                                        <p th:text="${javaVersion}">-</p>
                                        
                                        <p><strong>可用处理器:</strong></p>
                                        <p th:text="${availableProcessors}">-</p>
                                    </div>
                                    <div class="col-sm-6">
                                        <p><strong>系统运行时间:</strong></p>
                                        <p th:text="${uptime}">-</p>
                                        
                                        <p><strong>最大内存:</strong></p>
                                        <p th:text="${#numbers.formatDecimal(maxMemory, 1, 1)} + ' MB'">-</p>
                                        
                                        <p><strong>已分配内存:</strong></p>
                                        <p th:text="${#numbers.formatDecimal(totalMemory, 1, 1)} + ' MB'">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">内存使用情况</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>内存使用率</span>
                                        <span th:text="${#numbers.formatDecimal(memoryUsagePercent, 1, 1)} + '%'">-</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" 
                                             th:classappend="${memoryUsagePercent > 80} ? 'bg-danger' : (${memoryUsagePercent > 60} ? 'bg-warning' : 'bg-success')"
                                             th:style="'width: ' + ${memoryUsagePercent} + '%'"
                                             role="progressbar">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted">已使用</small>
                                        <div class="h5 text-primary" th:text="${#numbers.formatDecimal(usedMemory, 1, 1)} + ' MB'">-</div>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">空闲</small>
                                        <div class="h5 text-success" th:text="${#numbers.formatDecimal(freeMemory, 1, 1)} + ' MB'">-</div>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">总计</small>
                                        <div class="h5 text-info" th:text="${#numbers.formatDecimal(maxMemory, 1, 1)} + ' MB'">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12 mb-4">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">系统配置</h6>
                            </div>
                            <div class="card-body">
                                <form id="configForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="siteName" class="form-label">网站名称</label>
                                                <input type="text" class="form-control" id="siteName" name="siteName" value="Web安全平台">
                                            </div>
                                            <div class="mb-3">
                                                <label for="adminEmail" class="form-label">管理员邮箱</label>
                                                <input type="email" class="form-control" id="adminEmail" name="adminEmail" value="admin@example.com">
                                            </div>
                                            <div class="mb-3">
                                                <label for="maxFileSize" class="form-label">最大文件上传大小 (MB)</label>
                                                <input type="number" class="form-control" id="maxFileSize" name="maxFileSize" value="10" min="1" max="100">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="sessionTimeout" class="form-label">会话超时时间 (分钟)</label>
                                                <input type="number" class="form-control" id="sessionTimeout" name="sessionTimeout" value="30" min="5" max="120">
                                            </div>
                                            <div class="mb-3">
                                                <label for="maxLoginAttempts" class="form-label">最大登录尝试次数</label>
                                                <input type="number" class="form-control" id="maxLoginAttempts" name="maxLoginAttempts" value="5" min="3" max="10">
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="enableRegistration" name="enableRegistration" checked>
                                                    <label class="form-check-label" for="enableRegistration">
                                                        允许用户注册
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="enableEmailNotifications" name="enableEmailNotifications">
                                                    <label class="form-check-label" for="enableEmailNotifications">
                                                        启用邮件通知
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <button type="button" class="btn btn-primary" onclick="saveConfig()">
                                                <i class="bi bi-save"></i> 保存配置
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="resetConfig()">
                                                <i class="bi bi-arrow-clockwise"></i> 重置为默认值
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">确认操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    确定要执行此操作吗？
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmModalButton">确认</button>
                </div>
            </div>
        </div>
    </div>


    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script src="/js/navbar-enhancements.js"></script>
    <script>
        function saveConfig() {
            const form = document.getElementById('configForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            data.enableRegistration = form.querySelector('#enableRegistration').checked;
            data.enableEmailNotifications = form.querySelector('#enableEmailNotifications').checked;

            const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
            const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

            fetch('/admin/system/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    [csrfHeader]: csrfToken
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('配置保存成功');
                } else {
                    alert('配置保存失败：' + data.message);
                }
            })
            .catch(error => {
                alert('操作失败：' + error.message);
            });
        }

        function resetConfig() {
            document.getElementById('confirmModalTitle').textContent = '重置配置';
            document.getElementById('confirmModalBody').textContent = '确定要将所有配置重置为默认值吗？此操作不可恢复。';
            document.getElementById('confirmModalButton').onclick = function() {
                alert('配置已重置为默认值');
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            };
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }

        function clearCache() {
            document.getElementById('confirmModalTitle').textContent = '清理缓存';
            document.getElementById('confirmModalBody').textContent = '确定要清理系统缓存吗？这可能会暂时影响系统性能。';
            document.getElementById('confirmModalButton').onclick = function() {
                fetch('/admin/system/clear-cache', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('缓存清理成功');
                        } else {
                            alert('缓存清理失败：' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('操作失败：' + error.message);
                    });
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            };
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }

        function backupDatabase() {
            document.getElementById('confirmModalTitle').textContent = '备份数据库';
            document.getElementById('confirmModalBody').textContent = '确定要创建数据库备份吗？这可能需要几分钟时间。';
            document.getElementById('confirmModalButton').onclick = function() {
                const link = document.createElement('a');
                link.href = '/admin/system/backup-database';
                link.download = 'database_backup_' + new Date().toISOString().split('T')[0] + '.sql';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            };
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }

        function generateReport() {
            const link = document.createElement('a');
            link.href = '/admin/system/generate-report';
            link.download = 'system_report_' + new Date().toISOString().split('T')[0] + '.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function confirmRestart() {
            document.getElementById('confirmModalTitle').textContent = '重启系统';
            document.getElementById('confirmModalBody').textContent = '确定要重启系统吗？这将中断所有用户连接，请确保已保存所有工作。';
            document.getElementById('confirmModalButton').onclick = function() {
                fetch('/admin/system/restart', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('系统正在重启，请稍后刷新页面');
                            setTimeout(() => {
                                location.reload();
                            }, 10000);
                        } else {
                            alert('重启失败：' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('操作失败：' + error.message);
                    });
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            };
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }

        setInterval(() => {
            location.reload();
        }, 60000); 
    </script>
</body>
</html>
