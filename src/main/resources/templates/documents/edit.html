<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/navigation :: head"></head>
<body>
    <div th:replace="fragments/navigation :: navbar"></div>
    <div th:replace="fragments/navigation :: alerts"></div>

    <div class="container mt-4 min-vh-100">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="card animate-fade-in-up">
                    <div class="card-header">
                        <h3 class="text-center">
                            <i class="bi bi-pencil-square"></i> 编辑文档
                        </h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle"></i>
                            <span th:text="${error}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle"></i>
                            <span th:text="${success}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <form th:action="@{/documents/edit/{id}(id=${document.id})}" method="post" th:object="${document}">
                            <div class="mb-3">
                                <label for="title" class="form-label">文档标题 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" th:field="*{title}"
                                       placeholder="请输入文档标题" required />
                                <div th:if="${#fields.hasErrors('title')}" class="text-danger small">
                                    <span th:errors="*{title}"></span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">文档描述</label>
                                <textarea class="form-control" id="description" th:field="*{description}"
                                          rows="2" placeholder="请输入文档描述（可选）"></textarea>
                                <div class="form-text">简短描述文档内容，最多500个字符</div>
                            </div>

                            <div class="mb-3">
                                <label for="content" class="form-label">文档内容</label>
                                <textarea class="form-control" id="content" th:field="*{content}"
                                          rows="12" placeholder="请输入文档内容（支持Markdown格式）"></textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="form-text">
                                        <small>支持丰富的文本编辑，可以使用Markdown语法</small>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="togglePreview()">
                                            <i class="bi bi-eye"></i> 预览
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info ms-1" onclick="insertMarkdown('**', '**')">
                                            <i class="bi bi-type-bold"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info ms-1" onclick="insertMarkdown('*', '*')">
                                            <i class="bi bi-type-italic"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info ms-1" onclick="insertMarkdown('`', '`')">
                                            <i class="bi bi-code"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="previewArea" class="mb-3" style="display: none;">
                                <label class="form-label">预览</label>
                                <div class="border rounded p-3 bg-light" style="min-height: 200px;">
                                    <div id="previewContent"></div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="category" class="form-label">分类</label>
                                    <select class="form-select" id="category" th:field="*{category}">
                                        <option value="">选择分类</option>
                                        <option value="技术文档">技术文档</option>
                                        <option value="项目文档">项目文档</option>
                                        <option value="学习笔记">学习笔记</option>
                                        <option value="工作文档">工作文档</option>
                                        <option value="个人随笔">个人随笔</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="isPublic" class="form-label">可见性</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="isPublic" th:field="*{isPublic}" />
                                        <label class="form-check-label" for="isPublic">
                                            公开文档（其他用户可以查看）
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="tags" class="form-label">标签</label>
                                <input type="text" class="form-control" id="tags" th:field="*{tags}"
                                       placeholder="请输入标签，多个标签用逗号分隔" />
                                <div class="mt-2">
                                    <small class="text-muted">常用标签：</small>
                                    <div class="mt-1">
                                        <span class="badge bg-light text-dark me-1 tag-suggestion"
                                              onclick="addTag(this)">Java</span>
                                        <span class="badge bg-light text-dark me-1 tag-suggestion"
                                              onclick="addTag(this)">Spring</span>
                                        <span class="badge bg-light text-dark me-1 tag-suggestion"
                                              onclick="addTag(this)">数据库</span>
                                        <span class="badge bg-light text-dark me-1 tag-suggestion"
                                              onclick="addTag(this)">前端</span>
                                        <span class="badge bg-light text-dark me-1 tag-suggestion"
                                              onclick="addTag(this)">算法</span>
                                        <span class="badge bg-light text-dark me-1 tag-suggestion"
                                              onclick="addTag(this)">架构</span>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <h6><i class="bi bi-info-circle"></i> 文档信息</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>创建时间:</strong>
                                            <span th:text="${#temporals.format(document.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>最后更新:</strong>
                                            <span th:text="${#temporals.format(document.updatedAt, 'yyyy-MM-dd HH:mm')}"></span>
                                        </small>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>浏览次数:</strong>
                                            <span th:text="${document.viewCount ?: 0}"></span>
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>下载次数:</strong>
                                            <span th:text="${document.downloadCount ?: 0}"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                <div>
                                    <a th:href="@{/documents/view/{id}(id=${document.id})}" class="btn btn-outline-secondary">
                                        <i class="bi bi-x-circle"></i> 取消编辑
                                    </a>
                                    <a th:href="@{/documents/my}" class="btn btn-outline-info ms-2">
                                        <i class="bi bi-list"></i> 我的文档
                                    </a>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-circle"></i> 保存更改
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <div th:replace="fragments/navigation :: footer"></div>

    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script>
        function togglePreview() {
            const previewArea = document.getElementById('previewArea');
            const content = document.getElementById('content').value;
            const previewContent = document.getElementById('previewContent');

            if (previewArea.style.display === 'none') {
                let html = content
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/`(.+?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br />');

                previewContent.innerHTML = html;
                previewArea.style.display = 'block';
            } else {
                previewArea.style.display = 'none';
            }
        }

        function insertMarkdown(before, after) {
            const textarea = document.getElementById('content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const replacement = before + selectedText + after;

            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + before.length, start + before.length + selectedText.length);
        }

        function addTag(element) {
            const tagText = element.textContent;
            const tagsInput = document.getElementById('tags');
            const currentTags = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);

            if (!currentTags.includes(tagText)) {
                currentTags.push(tagText);
                tagsInput.value = currentTags.join(', ');
            }

            element.classList.add('bg-success', 'text-white');
            setTimeout(() => {
                element.classList.remove('bg-success', 'text-white');
            }, 500);
        }

        let autoSaveTimer;
        document.getElementById('content').addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                console.log('自动保存草稿...');
            }, 3000);
        });

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                document.querySelector('form').submit();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                togglePreview();
            }
        });
    </script>
</body>
</html>